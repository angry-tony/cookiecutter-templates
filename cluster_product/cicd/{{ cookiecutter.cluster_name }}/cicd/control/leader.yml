{%- macro password(size=16) -%}
{% for index in range(size) %}{{ 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'|random }}{% endfor %}
{%- endmacro %}
classes:
  # Services
  - system.docker.client
  - system.aptly.server.docker
  # Docker services
  - system.docker.swarm.stack.aptly
  - system.docker.swarm.stack.docker
  - system.docker.swarm.stack.gerrit
  - system.docker.swarm.stack.jenkins
  {%- if cookiecutter.openldap_enabled == 'True' %}
  - system.docker.swarm.stack.ldap
  {%- endif %}

  # Jenkins
  - system.jenkins.master.config
  - system.jenkins.client
  - system.jenkins.client.credential.gerrit
  - system.jenkins.client.credential.salt
  # Jobs
  - system.jenkins.client.job.aptly
  - system.jenkins.client.job.git-mirrors.downstream.pipelines
  - system.jenkins.client.job.deploy.openstack
  - system.jenkins.client.job.deploy.update
  # Security
  {%- if cookiecutter.openldap_enabled == 'True' %}
  - system.jenkins.client.security.ldap
  - system.jenkins.client.security.matrix
  {%- else %}
  - system.jenkins.client.user.admin
  {%- endif %}
  # Slaves
  - system.jenkins.client.node

  {%- if cookiecutter.openldap_enabled == 'True' %}
  # OpenLDAP
  - system.openldap.client
  - system.openldap.client.people.admin
  {%- endif %}

  # Gerrit
  - system.gerrit.client
  - system.gerrit.client.project.ci

  - system.docker.swarm.master

  - cluster.{{ cookiecutter.cluster_name }}.infra
  - cluster.{{ cookiecutter.cluster_name }}.cicd.control

parameters:
  _param:
    # Aptly
    aptly_gpg_keypair_id: none
    aptly_gpg_passphrase: none
    aptly_server_secure: false
    aptly_gpg_public_key: none
    aptly_gpg_private_key: none

    {%- if cookiecutter.openldap_enabled == 'True' %}
    # OpenLDAP
    openldap_organisation: "{{ cookiecutter.openldap_organisation }}"
    openldap_dn: "dc={{ cookiecutter.openldap_domain|replace('.', ',dc=') }}"
    openldap_domain: "{{ cookiecutter.openldap_domain }}"
    openldap_admin_password: {{ password(16) }}
    openldap_config_password: {{ password(16) }}
    openldap_readonly_password: {{ password(16) }}
    {%- endif %}

    # Jenkins
    jenkins_slave_user: admin
    jenkins_client_user: admin

    {%- if cookiecutter.openldap_enabled == 'True' %}
    jenkins_admin_password: ${_param:openldap_admin_password}
    jenkins_security_ldap_server: ${_param:cluster_vip_address}
    jenkins_security_ldap_root_dn: ${_param:openldap_dn}
    jenkins_security_ldap_manager_dn: "cn=admin,${_param:openldap_dn}"
    jenkins_security_ldap_manager_password: ${_param:openldap_admin_password}
    {%- else %}
    jenkins_admin_password: {{ password(16) }}
    {%- endif %}
    jenkins_slave_password: ${_param:jenkins_admin_password}
    jenkins_client_password: ${_param:jenkins_admin_password}
    jenkins_admin_email: ${_param:admin_email}
    jenkins_admin_public_key: {{ cookiecutter.cicd_public_key }}
    jenkins_admin_private_key: |
      {{ cookiecutter.cicd_private_key|indent(6) }}
    # Jobs params
    jenkins_gerrit_url: ssh://admin@${_param:haproxy_gerrit_bind_host}:${_param:haproxy_gerrit_ssh_bind_port}
    jenkins_aptly_api_url: http://${_param:haproxy_aptly_api_bind_host}:${_param:haproxy_aptly_api_bind_port}
    jenkins_aptly_url: http://${_param:haproxy_aptly_public_bind_host}:${_param:haproxy_aptly_public_bind_port}
    # Gerrit

    {%- if cookiecutter.openldap_enabled == 'True' %}
    gerrit_admin_password: ${_param:openldap_admin_password}
    {%- else %}
    gerrit_admin_password: {{ password(16) }}
    {%- endif %}
    gerrit_admin_email: ${_param:admin_email}
    gerrit_public_host: https://${_param:nginx_proxy_gerrit_server_site_host}:${_param:nginx_proxy_gerrit_server_site_port}
    gerrit_admin_public_key: ${_param:jenkins_admin_public_key}
    gerrit_admin_private_key: ${_param:jenkins_admin_private_key}
    {%- if cookiecutter.openldap_enabled == 'True' %}
    gerrit_auth_type: LDAP
    gerrit_ldap_server: "ldap://${_param:cluster_vip_address}"
    gerrit_ldap_bind_user: "cn=admin,${_param:openldap_dn}"
    gerrit_ldap_bind_password: ${_param:openldap_admin_password}
    gerrit_ldap_account_base: ou=people,${_param:openldap_dn}
    gerrit_ldap_group_base: ou=groups,${_param:openldap_dn}
    {%- else %}
    gerrit_auth_type: DEVELOPMENT_BECOME_ANY_ACCOUNT
    {%- endif %}
