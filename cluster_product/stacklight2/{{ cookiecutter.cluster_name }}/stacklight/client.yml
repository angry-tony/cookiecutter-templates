{%- macro password(size=16) -%}
{% for index in range(size) %}{{ 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'|random }}{% endfor %}
{%- endmacro -%}
classes:
- system.grafana.client
- system.grafana.client.datasource.prometheus
- system.docker.client
- system.docker.swarm.stack.dashboard
- system.docker.swarm.stack.monitoring
{%- if cookiecutter.openstack_enabled == 'True' %}
- system.docker.swarm.stack.monitoring.remote_collector
{%- endif %}

{%- if cookiecutter.oss_enabled == 'True' %}
# PostgreSQL
- system.postgresql.client.pushkin
- system.postgresql.client.rundeck
- system.postgresql.client.alertmanager
{%- if cookiecutter.oss_security_audit_enabled == 'True' %}
- system.postgresql.client.security_monkey

# Elasticsearch
- system.elasticsearch.client
- system.elasticsearch.client.index.pushkin
- system.elasticsearch.client.index.janitor_monkey

# DevOps Portal
- service.devops_portal.config
# Rundeck
- system.rundeck.server.docker
- system.rundeck.client
- system.rundeck.client.project.cicd

#- cluster.{{ cookiecutter.cluster_name }}.infra
#- cluster.{{ cookiecutter.cluster_name }}.cicd.control

# OSS Tooling
- system.docker.swarm.stack.devops_portal
- system.docker.swarm.stack.elasticsearch
- system.docker.swarm.stack.postgresql
- system.docker.swarm.stack.pushkin
- system.docker.swarm.stack.rundeck
{%- if cookiecutter.oss_security_audit_enabled == 'True' %}
- system.docker.swarm.stack.security_monkey
{%- endif %}
{%- if cookiecutter.oss_cleanup_service_enabled == 'True' %}
- system.docker.swarm.stack.janitor_monkey
{%- endif %}

# Docker networks
- system.docker.swarm.network.runbook

- system.devops_portal.service.elasticsearch
- system.devops_portal.service.gerrit
- system.devops_portal.service.jenkins
- system.devops_portal.service.pushkin
- system.devops_portal.service.rundeck
{%- if cookiecutter.oss_security_audit_enabled == 'True' %}
- system.devops_portal.service.security_monkey
{%- endif %}
{%- if cookiecutter.oss_cleanup_service_enabled == 'True' %}
- system.devops_portal.service.janitor_monkey
{%- endif %}

# Rundeck
- system.rundeck.client.runbook
{%- endif %}
{%- endif %}
parameters:
  _param:
    {%- if cookiecutter.oss_enabled == 'True' %}
    # DevOps Portal
    docker_image_devops_portal: {{ cookiecutter.oss_portal_image }}

    # ElasticSearch
    docker_image_elasticsearch: {{ cookiecutter.oss_elasticsearch_image }}

    # PostgreSQL
    docker_image_postgresql: {{ cookiecutter.oss_postgresql_image }}
    postgresql_admin_user_password: {{ password(16) }}
    postgresql_client_user: ${_param:postgresql_admin_user}
    postgresql_client_password: ${_param:postgresql_admin_user_password}
    postgresql_client_host: ${_param:haproxy_postgresql_bind_host}
    postgresql_client_port: ${_param:haproxy_postgresql_bind_port}

    # Pushkin
    docker_image_pushkin: {{ cookiecutter.oss_pushkin_image }}
    pushkin_db_user: pushkin
    pushkin_db_user_password: {{ password(16) }}
    pushkin_db_host: ${_param:haproxy_postgresql_bind_host}
    pushkin_smtp_host: {{ cookiecutter.oss_notification_smtp_host }}
    pushkin_smtp_port: {{ cookiecutter.oss_notification_smtp_port }}
    pushkin_email_sender_password: {{ cookiecutter.oss_notification_sender_password }}
    #..WebHook notification senders
    webhook_from: {{ cookiecutter.oss_notification_email_from }}
    webhook_recipients: {{ cookiecutter.oss_notification_email_recipients }}
    webhook_sfdc_username: {{ cookiecutter.oss_notification_saleforce_username }}
    webhook_login_id: {{ cookiecutter.oss_notification_webhook_login_id }}
    webhook_application_id: {{ cookiecutter.oss_notification_webhook_app_id }}

    # OSS OpenStack
    oss_openstack_username: {{ cookiecutter.oss_openstack_username }}
    oss_openstack_password: {{ cookiecutter.oss_openstack_password }}
    oss_openstack_project: {{ cookiecutter.oss_openstack_project }}
    oss_openstack_domain_id: {{ cookiecutter.oss_openstack_domain_id }}
    oss_openstack_username_domain_id: {{ cookiecutter.oss_openstack_username_domain_id }}
    oss_openstack_cert: |
      {{ cookiecutter.oss_openstack_cert }}

    {%- if cookiecutter.oss_security_audit_enabled == 'True' %}
    # SecurityMonkey
    docker_image_security_monkey_api: {{ cookiecutter.oss_security_monkey_api_image }}
    docker_image_security_monkey_scheduler: {{ cookiecutter.oss_security_monkey_scheduler_image }}
    secmonkey_db_user: secmonkey
    secmonkey_db_user_password: {{ password(16) }}
    secmonkey_db_host: ${_param:haproxy_postgresql_bind_host}
    security_monkey_os_ssl_verify: {{ cookiecutter.oss_security_audit_os_ssl_verify }}
    security_monkey_openstack:
      username: {{ cookiecutter.oss_security_audit_username }}
      password: {{ cookiecutter.oss_security_audit_password }}
      auth_url: {{ cookiecutter.oss_openstack_auth_url }}
      user_domain_name: {{ cookiecutter.oss_security_audit_user_domain_id }}
      project_domain_name: {{ cookiecutter.oss_security_audit_project_domain_id }}
      cacert_path: {{ cookiecutter.oss_security_audit_os_cacert_path }}
    {%- endif %}

    {%- if cookiecutter.oss_cleanup_service_enabled == 'True' %}
    # JanitorMonkey
    docker_image_janitor_monkey: {{ cookiecutter.oss_janitor_monkey_image }}
    docker_image_mongodb: {{ cookiecutter.oss_mongodb_image }}
    docker_mongodb_admin_username: admin
    docker_mongodb_admin_password: {{ password(16) }}
    janitor_monkey_mongodb_host: ${_param:haproxy_mongodb_bind_host}
    janitor_monkey_openstack:
      username: {{ cookiecutter.oss_cleanup_service_username }}
      password: {{ cookiecutter.oss_cleanup_service_password }}
      auth_url: {{ cookiecutter.oss_openstack_auth_url }}
      project_name: {{ cookiecutter.oss_cleanup_service_project }}
      project_domain_name: {{ cookiecutter.oss_cleanup_service_project_domain_id }}
    {%- endif %}

    # Rundeck
    docker_image_rundeck: {{ cookiecutter.oss_rundeck_image }}
    rundeck_db_user: rundeck
    rundeck_db_user_password: {{ password(16) }}
    rundeck_db_host: ${_param:haproxy_postgresql_bind_host}
    rundeck_postgresql_username: ${_param:rundeck_db_user}
    rundeck_postgresql_password: ${_param:rundeck_db_user_password}
    rundeck_postgresql_database: rundeck
    rundeck_postgresql_host: ${_param:rundeck_db_host}

    rundeck_runbook_public_key: {{ cookiecutter.oss_runbook_public_key }}
    rundeck_runbook_private_key: |
      {{ cookiecutter.oss_runbook_private_key|indent(6) }}

    {%- if cookiecutter.oss_cis_enabled == 'True' %}
    # CIS
    rundeck_cis_enabled: {{ cookiecutter.oss_cis_enabled }}
    rundeck_cis_jobs_repository: {{ cookiecutter.oss_cis_jobs_repository }}
    rundeck_cis_jobs_revision: {{ cookiecutter.oss_cis_jobs_repository_branch }}
    rundeck_cis_os_auth_url: {{ cookiecutter.oss_openstack_auth_url }}/auth/tokens
    rundeck_cis_os_username: {{ cookiecutter.oss_cis_username }}
    rundeck_cis_os_password: {{ cookiecutter.oss_cis_password }}
    rundeck_cis_os_project_name: {{ cookiecutter.oss_cis_project }}
    rundeck_cis_os_domain_id: {{ cookiecutter.oss_cis_domain_id }}
    rundeck_cis_os_docker_image: {{ cookiecutter.oss_cis_openstack_image }}
    rundeck_cis_elasticsearch_url: http://${_param:haproxy_elasticsearch_bind_host}:${_param:haproxy_elasticsearch_http_bind_port}
    {%- endif %}
    {%- endif %}

    # Grafana client parameters
    grafana_address: ${_param:stacklight_monitor_address}
    grafana_port: 15013
    grafana_user: admin
    grafana_password: ${_param:grafana_admin_password}
    grafana_prometheus_address: ${_param:stacklight_monitor_address}
    grafana_prometheus_port: 15010

